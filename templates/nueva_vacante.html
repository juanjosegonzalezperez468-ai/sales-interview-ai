<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nueva Vacante | Sales AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8 font-sans">
    <div class="max-w-3xl mx-auto">
        
        <div class="mb-6">
            <a href="/dashboard" class="text-slate-400 hover:text-blue-600 font-bold text-sm transition">â† Volver al Dashboard</a>
        </div>

        <div class="flex items-center gap-3 mb-8">
            <div class="bg-blue-600 p-3 rounded-2xl text-2xl shadow-lg shadow-blue-200">âœ¨</div>
            <h1 class="text-2xl font-black text-slate-800 tracking-tight">Crear Nueva Vacante</h1>
        </div>

        <form method="POST" id="form-vacante" class="space-y-6">

            <!-- Nombre del cargo -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Nombre del Cargo</label>
                <input type="text" name="cargo" placeholder="Ej: Ejecutivo de Ventas Senior" required
                       class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700">
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SECCIÃ“N: HABILIDADES CRÃTICAS
                 MÃ­nimo 3 Â· MÃ¡ximo 5
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">

                <!-- Header -->
                <div class="flex items-start justify-between mb-1">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-slate-400 tracking-widest">
                            Habilidades CrÃ­ticas para este Rol
                        </label>
                        <p class="text-xs text-slate-400 mt-1">Selecciona entre 3 y 5 habilidades. Estas guiarÃ¡n la evaluaciÃ³n IA.</p>
                    </div>
                    <!-- Contador -->
                    <div class="flex items-center gap-1.5 bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5">
                        <span id="contador-hab" class="text-lg font-black text-slate-300">0</span>
                        <span class="text-xs text-slate-400 font-bold">/ 5</span>
                    </div>
                </div>

                <!-- Barra de progreso mÃ­nimo -->
                <div class="flex items-center gap-2 mb-5 mt-3">
                    <div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div id="barra-hab" class="h-full rounded-full transition-all duration-300 bg-slate-200" style="width:0%"></div>
                    </div>
                    <span id="label-minimo" class="text-[10px] font-bold text-slate-400 whitespace-nowrap">mÃ­n. 3</span>
                </div>

                <!-- Grid de habilidades -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="grid-habilidades">

                    <!-- Ventas y NegociaciÃ³n -->
                    <button type="button" data-hab="ProspecciÃ³n" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ¯</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">ProspecciÃ³n</p>
                    </button>

                    <button type="button" data-hab="Cierre de Ventas" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ¤</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">Cierre de Ventas</p>
                    </button>

                    <button type="button" data-hab="NegociaciÃ³n" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ’¬</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">NegociaciÃ³n</p>
                    </button>

                    <button type="button" data-hab="Manejo de CRM" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ’»</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">Manejo de CRM</p>
                    </button>

                    <button type="button" data-hab="ComunicaciÃ³n" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ“£</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">ComunicaciÃ³n</p>
                    </button>

                    <button type="button" data-hab="Trabajo en Equipo" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ‘¥</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">Trabajo en Equipo</p>
                    </button>

                    <button type="button" data-hab="OrientaciÃ³n a Resultados" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ“ˆ</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">OrientaciÃ³n a Resultados</p>
                    </button>

                    <button type="button" data-hab="Resiliencia" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ’ª</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">Resiliencia</p>
                    </button>

                    <button type="button" data-hab="AutonomÃ­a" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ§­</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">AutonomÃ­a</p>
                    </button>

                    <button type="button" data-hab="Escucha Activa" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ‘‚</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">Escucha Activa</p>
                    </button>

                    <button type="button" data-hab="GestiÃ³n del Tiempo" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">â±ï¸</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">GestiÃ³n del Tiempo</p>
                    </button>

                    <button type="button" data-hab="Liderazgo" onclick="toggleHab(this)"
                            class="hab-btn text-left px-4 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 hover:border-blue-200 hover:bg-blue-50 transition-all">
                        <span class="text-base">ğŸ†</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">Liderazgo</p>
                    </button>

                </div>

                <!-- Mensaje de validaciÃ³n -->
                <p id="msg-hab" class="text-xs font-bold text-rose-400 mt-3 hidden">
                    âš ï¸ Debes seleccionar al menos 3 habilidades crÃ­ticas.
                </p>

                <!-- Input oculto que envÃ­a al backend -->
                <input type="hidden" name="habilidades_seleccionadas" id="habilidades-seleccionadas" value="">
            </div>
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <!-- Preguntas -->
            <div id="contenedor-preguntas" class="space-y-6"></div>

            <div class="space-y-4">
                <button type="button" onclick="agregarPregunta()"
                        class="w-full py-4 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold hover:bg-slate-100 hover:border-blue-300 hover:text-blue-500 transition-all">
                    + AÃ±adir Pregunta
                </button>

                <div class="sticky bottom-6 pt-4">
                    <button type="submit"
                            class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all tracking-widest uppercase">
                        Crear y Publicar Vacante
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LÃ“GICA DE HABILIDADES CRÃTICAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const MAX_HAB = 5;
        const MIN_HAB = 3;
        let seleccionadas = [];

        function toggleHab(btn) {
            const hab = btn.dataset.hab;
            const idx = seleccionadas.indexOf(hab);

            if (idx === -1) {
                // Quiere seleccionar
                if (seleccionadas.length >= MAX_HAB) return; // bloquear si ya hay 5
                seleccionadas.push(hab);
                btn.classList.remove('border-slate-100', 'bg-slate-50', 'hover:border-blue-200', 'hover:bg-blue-50');
                btn.classList.add('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
                btn.querySelector('p').classList.add('text-blue-700');
                btn.querySelector('p').classList.remove('text-slate-600');
            } else {
                // Quiere deseleccionar
                seleccionadas.splice(idx, 1);
                btn.classList.add('border-slate-100', 'bg-slate-50', 'hover:border-blue-200', 'hover:bg-blue-50');
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
                btn.querySelector('p').classList.remove('text-blue-700');
                btn.querySelector('p').classList.add('text-slate-600');
            }

            actualizarUI();
        }

        function actualizarUI() {
            const n = seleccionadas.length;

            // Contador
            const contador = document.getElementById('contador-hab');
            contador.textContent = n;
            if (n >= MIN_HAB && n <= MAX_HAB) {
                contador.classList.remove('text-slate-300', 'text-rose-400');
                contador.classList.add('text-blue-600');
            } else if (n === 0) {
                contador.classList.add('text-slate-300');
                contador.classList.remove('text-blue-600', 'text-rose-400');
            } else {
                contador.classList.remove('text-slate-300', 'text-blue-600');
                contador.classList.add('text-rose-400');
            }

            // Barra de progreso (sobre el mÃ­nimo de 3)
            const barra = document.getElementById('barra-hab');
            const pct = Math.min((n / MAX_HAB) * 100, 100);
            barra.style.width = pct + '%';
            if (n >= MIN_HAB) {
                barra.classList.remove('bg-slate-200', 'bg-rose-300');
                barra.classList.add('bg-blue-500');
            } else if (n > 0) {
                barra.classList.remove('bg-slate-200', 'bg-blue-500');
                barra.classList.add('bg-rose-300');
            } else {
                barra.classList.remove('bg-blue-500', 'bg-rose-300');
                barra.classList.add('bg-slate-200');
            }

            // Bloquear botones no seleccionados si ya hay 5
            document.querySelectorAll('.hab-btn').forEach(b => {
                const estaSeleccionado = seleccionadas.includes(b.dataset.hab);
                if (n >= MAX_HAB && !estaSeleccionado) {
                    b.classList.add('opacity-40', 'cursor-not-allowed');
                } else {
                    b.classList.remove('opacity-40', 'cursor-not-allowed');
                }
            });

            // Input oculto para el backend
            document.getElementById('habilidades-seleccionadas').value = seleccionadas.join(',');

            // Ocultar mensaje de error si ya cumple
            if (n >= MIN_HAB) {
                document.getElementById('msg-hab').classList.add('hidden');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LÃ“GICA DE PREGUNTAS (sin cambios)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function alternarCampos(select) {
            const card = select.closest('.pregunta-card');
            const seccionMultiple = card.querySelector('.seccion-multiple');
            const labelRegla = card.querySelector('.label-regla');
            if (select.value === 'multiple') {
                seccionMultiple.classList.remove('hidden');
                labelRegla.innerText = "Respuesta Correcta (Debe ser idÃ©ntica a una opciÃ³n)";
            } else {
                seccionMultiple.classList.add('hidden');
                labelRegla.innerText = "Regla (Ideal / Keywords)";
            }
        }

        function agregarOpcion(btn) {
            const lista = btn.previousElementSibling;
            if (lista.children.length < 4) {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2";
                div.innerHTML = `
                    <input type="text" name="p_opciones_lista[]" placeholder="OpciÃ³n..."
                           class="flex-1 p-2 bg-white border border-slate-200 rounded-lg text-xs outline-none focus:border-blue-400">
                    <button type="button" onclick="this.parentElement.remove()" class="text-slate-300 hover:text-rose-500">âœ•</button>
                `;
                lista.appendChild(div);
            }
        }

        function agregarPregunta() {
            const contenedor = document.getElementById('contenedor-preguntas');
            const index = contenedor.children.length;
            const nuevaHtml = `
                <div class="pregunta-card bg-white p-6 rounded-3xl shadow-sm border border-slate-100 space-y-4 relative">
                    <input type="hidden" name="p_id[]" value="q_nueva_${Date.now()}">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black text-blue-600 uppercase tracking-widest">Pregunta #${index + 1}</span>
                        <button type="button" onclick="this.closest('.pregunta-card').remove()" class="text-slate-300 hover:text-rose-500 transition font-bold text-lg">âœ•</button>
                    </div>
                    <input type="text" name="p_texto[]" required placeholder="Escribe la pregunta aquÃ­..."
                           class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-sm outline-none focus:bg-white transition">
                    <div class="grid grid-cols-2 gap-4">
                        <select name="p_tipo[]" onchange="alternarCampos(this)"
                                class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-sm font-medium">
                            <option value="si_no">SÃ­ / No</option>
                            <option value="multiple">OpciÃ³n MÃºltiple</option>
                            <option value="abierta">Abierta (IA)</option>
                        </select>
                        <input type="number" name="p_peso[]" placeholder="Peso %"
                               class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-sm">
                    </div>
                    <div class="seccion-multiple hidden space-y-3 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <label class="block text-[10px] font-black uppercase text-slate-400">Opciones (MÃ¡ximo 4)</label>
                        <div class="lista-opciones space-y-2"></div>
                        <button type="button" onclick="agregarOpcion(this)" class="text-blue-600 text-[10px] font-black uppercase">+ AÃ±adir OpciÃ³n</button>
                    </div>
                    <div class="seccion-regla">
                        <label class="label-regla block text-[10px] font-black uppercase text-slate-400 mb-1">Regla (Ideal / Keywords)</label>
                        <input type="text" name="p_regla[]" required placeholder="si / no / palabra clave"
                               class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-700 font-bold">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="p_ko[]" value="${index}" class="w-4 h-4 rounded text-blue-600">
                        <label class="text-[10px] font-bold text-rose-500 uppercase">Â¿KO? (Elimina al candidato si falla)</label>
                    </div>
                </div>`;
            contenedor.insertAdjacentHTML('beforeend', nuevaHtml);
        }

        window.onload = agregarPregunta;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VALIDACIÃ“N AL ENVIAR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('form-vacante').onsubmit = function(e) {

            // 1. Validar habilidades crÃ­ticas (mÃ­nimo 3)
            if (seleccionadas.length < MIN_HAB) {
                e.preventDefault();
                document.getElementById('msg-hab').classList.remove('hidden');
                document.getElementById('grid-habilidades').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }

            // 2. Validar suma de pesos = 100
            const pesos = document.getElementsByName('p_peso[]');
            let total = 0;
            pesos.forEach(p => { total += parseFloat(p.value || 0); });
            if (total !== 100) {
                e.preventDefault();
                alert("ğŸš¨ Error: La suma de los pesos debe ser exactamente 100%.\nActualmente suma: " + total + "%");
                return false;
            }

            // 3. Sincronizar Ã­ndices de KO
            const cards = document.querySelectorAll('.pregunta-card');
            cards.forEach((card, i) => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.value = i;
            });
        };
    </script>
</body>
</html>