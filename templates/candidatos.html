<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Candidatos | Sales AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .crm-tabs {
            display: flex; gap: 10px; margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200); padding-bottom: 0px;
        }
        .tab-btn {
            padding: 1rem 1.5rem; border: none; background: none; cursor: pointer;
            font-weight: 600; color: var(--gray-500); border-bottom: 3px solid transparent;
            transition: all 0.3s ease; font-size: 0.95rem;
        }
        .tab-btn:hover { color: var(--primary-blue); background: var(--gray-100); }
        .tab-btn.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        .crm-select {
            padding: 8px 12px; border-radius: 10px; border: 1px solid var(--gray-200);
            font-weight: 600; font-size: 0.85rem; cursor: pointer; outline: none; transition: all 0.2s;
        }
        .status-evaluado  { background-color: #f3f4f6; color: #374151; }
        .status-meet      { background-color: #fef3c7; color: #92400e; }
        .status-contratado{ background-color: #d1fae5; color: #065f46; }
        .status-rechazado { background-color: #fee2e2; color: #991b1b; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(15,23,42,0.6); backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; margin: 5% auto; padding: 2.5rem; width: 70%; max-width: 900px;
            border-radius: 20px; position: relative; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { position: absolute; right: 25px; top: 15px; font-size: 32px; font-weight: bold; color: var(--gray-400); cursor: pointer; }

        .score-high   { color: #065f46; background: #d1fae5; border: 1px solid #a7f3d0; }
        .score-medium { color: #92400e; background: #fef3c7; border: 1px solid #fde68a; }
        .score-low    { color: #991b1b; background: #fee2e2; border: 1px solid #fecaca; }

        /* Comparador */
        .check-comparar { width: 16px; height: 16px; cursor: pointer; accent-color: #4f46e5; }
        .candidato-row.seleccionada { background: #eef2ff !important; }
        #btn-comparar-crm {
            display: none; align-items: center; gap: 8px;
            padding: 10px 20px; background: #4f46e5; color: white;
            border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(79,70,229,0.3);
        }
        #btn-comparar-crm:hover { background: #4338ca; transform: translateY(-1px); }
        #hint-comparar {
            font-size: 0.8rem; color: var(--gray-400); font-style: italic;
        }
    </style>
</head>
<body style="background-color: var(--gray-50);">

    <nav class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo">
                <div class="logo-icon">S</div>
                <span>SALES AI</span>
            </a>
            <div class="nav-actions">
                <a href="/dashboard" class="btn-secondary">Volver al Dashboard</a>
            </div>
        </div>
    </nav>

    <header class="page-hero">
        <div class="container">
            <h1>üíº CRM de Selecci√≥n</h1>
            <p>Gestiona el flujo desde el Lead de IA hasta la contrataci√≥n final.</p>
        </div>
    </header>

    <main class="container" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-2xl);">

        <div class="crm-tabs">
            <button onclick="filtrarPorPesta√±a('TODOS', this)" class="tab-btn active">Todos</button>
            <button onclick="filtrarPorPesta√±a('Evaluado', this)" class="tab-btn">1. Leads (IA)</button>
            <button onclick="filtrarPorPesta√±a('Agendado Meet', this)" class="tab-btn">2. En Meet</button>
            <button onclick="filtrarPorPesta√±a('FINALIZADOS', this)" class="tab-btn">3. Cierre</button>
        </div>

        <!-- Barra de filtros + comparador -->
        <div style="background: white; padding: 1.25rem; border-radius: 16px; margin-bottom: 1.5rem;
                    display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;
                    box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
            <div style="flex: 1; position: relative; min-width: 200px;">
                <input type="text" id="searchInput" onkeyup="aplicarFiltros()"
                       placeholder="üîç Buscar por nombre, identificaci√≥n o vacante..."
                       style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-200);
                              border-radius: 10px; font-size: 0.95rem;">
            </div>

            <!-- Contador + comparador -->
            <span id="hint-comparar">Selecciona 2 candidatos para comparar</span>
            <button id="btn-comparar-crm" onclick="irComparador()">
                ‚öñÔ∏è Comparar seleccionados
            </button>
            <div style="color: var(--gray-400); font-size: 0.85rem; font-weight: 500; white-space: nowrap;">
                <span id="contadorCandidatos">{{ candidatos|length }}</span> candidatos
            </div>
        </div>

        <div class="problem-card" style="width: 100%; overflow-x: auto; border-radius: 16px; border: 1px solid var(--gray-200);">
            <table id="candidatosTable" style="width: 100%; border-collapse: collapse; text-align: left;">
                <thead>
                    <tr style="background: var(--gray-50); border-bottom: 2px solid var(--gray-200);">
                        <th style="padding: 1.25rem 0.75rem; width: 40px;"></th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">CANDIDATO / VACANTE</th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">SCORE IA</th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">ESTADO PROCESO</th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="tablaBody">
                    {% for c in candidatos %}
                    <tr class="candidato-row"
                        data-estado="{{ c.estado if c.estado and c.estado != 'None' else 'Evaluado' }}"
                        style="border-bottom: 1px solid var(--gray-100); transition: 0.2s;">

                        <!-- Checkbox comparador -->
                        <td style="padding: 1.25rem 0.75rem; text-align: center;">
                            <input type="checkbox"
                                   class="check-comparar"
                                   data-id="{{ c.id }}"
                                   data-nombre="{{ c.nombre_candidato }}"
                                   onchange="actualizarComparador(this, this.closest('tr'))">
                        </td>

                        <td style="padding: 1.25rem;">
                            <div class="nombre-candidato" style="font-weight: 600; color: var(--gray-900); font-size: 1rem;">
                                {{ c.nombre_candidato }}
                            </div>
                            <div style="font-size: 0.8rem; color: #2563eb; font-weight: bold; margin-top: 2px;">
                                üìå {{ c.vacante if c.vacante and c.vacante != 'None' else 'General' }}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--gray-500);">ID: {{ c.identificacion }}</div>
                        </td>

                        <td style="padding: 1.25rem;">
                            <span class="score-mini {% if c.score|int >= 75 %}score-high{% elif c.score|int >= 50 %}score-medium{% else %}score-low{% endif %}"
                                  style="padding: 4px 10px; border-radius: 8px; font-weight: 700;">
                                {{ c.score if c.score is not none else 0 }}%
                            </span>
                        </td>

                        <td style="padding: 1.25rem;">
                            <select onchange="cambiarEstado('{{ c.id }}', this)"
                                    class="crm-select
                                    {% if c.estado == 'Agendado Meet' %}status-meet
                                    {% elif c.estado == 'Contratado' %}status-contratado
                                    {% elif c.estado == 'Rechazado' %}status-rechazado
                                    {% else %}status-evaluado{% endif %}">
                                <option value="Evaluado"      {% if c.estado == 'Evaluado' or not c.estado or c.estado == 'None' %}selected{% endif %}>üÜï Evaluado por IA</option>
                                <option value="Agendado Meet" {% if c.estado == 'Agendado Meet' %}selected{% endif %}>üìÖ Agendado Meet</option>
                                <option value="Contratado"    {% if c.estado == 'Contratado' %}selected{% endif %}>‚úÖ Contratado</option>
                                <option value="Rechazado"     {% if c.estado == 'Rechazado' %}selected{% endif %}>‚ùå Rechazado</option>
                            </select>
                        </td>

                        <td style="padding: 1.25rem; display: flex; gap: 0.5rem; align-items: center;">
                            <button onclick="verDetalle('{{ c.nombre_candidato }}', '{{ c.fortalezas }}', '{{ c.debilidades }}', '{{ c.analisis_ia }}', '{{ c.score }}')"
                                    class="btn-secondary" style="padding: 0.5rem 0.8rem; font-size: 0.8rem;">
                                üëÅÔ∏è Detalle
                            </button>
                            {% if c.telefono %}
                            <a href="https://wa.me/{{ c.telefono }}?text=Hola%20{{ c.nombre_candidato }},%20nos%20gustar√≠a%20agendar%20una%20entrevista%20por%20Meet..."
                               target="_blank" class="btn-primary"
                               style="text-decoration: none; padding: 0.5rem 0.8rem; font-size: 0.8rem;">
                                WhatsApp
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal detalle -->
    <div id="detalleModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal()">&times;</span>
            <h2 id="modalNombre" style="color: var(--gray-900);">Nombre</h2>
            <div id="modalScoreValue" style="display:inline-block; padding: 5px 15px; border-radius: 8px; font-weight: bold; margin-bottom: 1rem;">0%</div>
            <hr style="border: 0; border-top: 1px solid var(--gray-200); margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px;">
                    <h4>‚úÖ Fortalezas</h4>
                    <p id="modalFortalezas"></p>
                </div>
                <div style="background: #fef2f2; padding: 1.5rem; border-radius: 12px;">
                    <h4>‚ùå Debilidades</h4>
                    <p id="modalDebilidades"></p>
                </div>
            </div>
            <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 12px;">
                <h4>üí° An√°lisis Profundo (IA)</h4>
                <p id="modalAnalisis"></p>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ Pesta√±as ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function filtrarPorPesta√±a(estadoRecibido, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            let visibles = 0;
            document.querySelectorAll('.candidato-row').forEach(row => {
                let rowEstado = row.getAttribute('data-estado') || 'Evaluado';
                if (['None','','null'].includes(rowEstado)) rowEstado = 'Evaluado';
                let mostrar = false;
                if (estadoRecibido === 'TODOS') mostrar = true;
                else if (estadoRecibido === 'FINALIZADOS') mostrar = ['Contratado','Rechazado'].includes(rowEstado);
                else mostrar = rowEstado === estadoRecibido;
                row.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });
            document.getElementById('contadorCandidatos').innerText = visibles;
        }

        // ‚îÄ‚îÄ B√∫squeda ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function aplicarFiltros() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            let visibles = 0;
            document.querySelectorAll('.candidato-row').forEach(row => {
                const match = row.innerText.toLowerCase().includes(q);
                row.style.display = match ? '' : 'none';
                if (match) visibles++;
            });
            document.getElementById('contadorCandidatos').innerText = visibles;
        }

        // ‚îÄ‚îÄ Estado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function cambiarEstado(id, el) {
            const nuevoEstado = el.value;
            el.closest('.candidato-row').setAttribute('data-estado', nuevoEstado);
            el.classList.remove('status-evaluado','status-meet','status-contratado','status-rechazado');
            const map = { 'Agendado Meet':'status-meet','Contratado':'status-contratado','Rechazado':'status-rechazado' };
            el.classList.add(map[nuevoEstado] || 'status-evaluado');
            fetch('/actualizar_estado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, estado: nuevoEstado })
            }).then(r => {
                if (r.ok) {
                    const activa = document.querySelector('.tab-btn.active');
                    if (activa && activa.innerText !== 'Todos') activa.click();
                }
            });
        }

        // ‚îÄ‚îÄ Modal detalle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function verDetalle(nombre, fortalezas, debilidades, analisis, score) {
            document.getElementById('modalNombre').innerText     = nombre;
            document.getElementById('modalFortalezas').innerText = fortalezas || 'N/A';
            document.getElementById('modalDebilidades').innerText= debilidades || 'N/A';
            document.getElementById('modalAnalisis').innerText   = analisis   || 'N/A';
            const scoreDiv = document.getElementById('modalScoreValue');
            scoreDiv.innerText = 'Score IA: ' + score + '%';
            const s = parseInt(score);
            scoreDiv.style.background = s >= 75 ? '#d1fae5' : s >= 50 ? '#fef3c7' : '#fee2e2';
            scoreDiv.style.color      = s >= 75 ? '#065f46' : s >= 50 ? '#92400e' : '#991b1b';
            document.getElementById('detalleModal').style.display = 'block';
        }
        function cerrarModal() { document.getElementById('detalleModal').style.display = 'none'; }

        // ‚îÄ‚îÄ COMPARADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const seleccionados = {};

        function actualizarComparador(checkbox, row) {
            const id     = checkbox.dataset.id;
            const nombre = checkbox.dataset.nombre;

            if (checkbox.checked) {
                if (Object.keys(seleccionados).length >= 2) {
                    checkbox.checked = false;
                    return;
                }
                seleccionados[id] = nombre;
                row.classList.add('seleccionada');
            } else {
                delete seleccionados[id];
                row.classList.remove('seleccionada');
            }

            const count = Object.keys(seleccionados).length;
            const btn   = document.getElementById('btn-comparar-crm');
            const hint  = document.getElementById('hint-comparar');

            if (count === 2) {
                btn.style.display  = 'inline-flex';
                hint.style.display = 'none';
            } else {
                btn.style.display  = 'none';
                hint.style.display = 'inline';
                hint.innerText     = count === 1
                    ? 'Selecciona 1 candidato m√°s para comparar'
                    : 'Selecciona 2 candidatos para comparar';
            }
        }

        function irComparador() {
            const ids = Object.keys(seleccionados);
            if (ids.length !== 2) return;
            window.location.href = `/comparar?c1=${ids[0]}&c2=${ids[1]}`;
        }
    </script>
</body>
</html>