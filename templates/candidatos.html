<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Candidatos | Sales AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* --- ESTILOS CRM Y PESTA√ëAS --- */
        .crm-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0px;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-500);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .tab-btn:hover { color: var(--primary-blue); background: var(--gray-100); }

        .tab-btn.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        .crm-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--gray-200);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        /* Colores din√°micos para los estados */
        .status-evaluado { background-color: #f3f4f6; color: #374151; }
        .status-meet { background-color: #fef3c7; color: #92400e; }
        .status-contratado { background-color: #d1fae5; color: #065f46; }
        .status-rechazado { background-color: #fee2e2; color: #991b1b; }

        /* Estilos Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; margin: 5% auto; padding: 2.5rem; width: 70%; max-width: 900px; 
            border-radius: 20px; position: relative; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { position: absolute; right: 25px; top: 15px; font-size: 32px; font-weight: bold; color: var(--gray-400); cursor: pointer; }

        .score-high { color: #065f46; background: #d1fae5; border: 1px solid #a7f3d0; }
        .score-medium { color: #92400e; background: #fef3c7; border: 1px solid #fde68a; }
        .score-low { color: #991b1b; background: #fee2e2; border: 1px solid #fecaca; }
    </style>
</head>
<body style="background-color: var(--gray-50);">

    <nav class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo">
                <div class="logo-icon">S</div>
                <span>SALES AI</span>
            </a>
            <div class="nav-actions">
                <a href="/dashboard" class="btn-secondary">Volver al Dashboard</a>
            </div>
        </div>
    </nav>

    <header class="page-hero">
        <div class="container">
            <h1>üíº CRM de Selecci√≥n</h1>
            <p>Gestiona el flujo desde el Lead de IA hasta la contrataci√≥n final.</p>
        </div>
    </header>

    <main class="container" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-2xl);">
        
        <div class="crm-tabs">
            <button onclick="filtrarPorPesta√±a('TODOS', this)" class="tab-btn active">Todos</button>
            <button onclick="filtrarPorPesta√±a('Evaluado', this)" class="tab-btn">1. Leads (IA)</button>
            <button onclick="filtrarPorPesta√±a('Agendado Meet', this)" class="tab-btn">2. En Meet</button>
            <button onclick="filtrarPorPesta√±a('FINALIZADOS', this)" class="tab-btn">3. Cierre</button>
        </div>

        <div class="filters-bar" style="background: white; padding: 1.25rem; border-radius: 16px; margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
            <div style="flex: 1; position: relative;">
                <input type="text" id="searchInput" onkeyup="aplicarFiltros()" placeholder="üîç Buscar por nombre o identificaci√≥n..." 
                       style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 0.95rem;">
            </div>
            <div style="color: var(--gray-400); font-size: 0.85rem; font-weight: 500;">
                <span id="contadorCandidatos">{{ candidatos|length }}</span> candidatos mostrados
            </div>
        </div>

        <div class="problem-card" style="width: 100%; overflow-x: auto; border-radius: 16px; border: 1px solid var(--gray-200);">
            <table id="candidatosTable" style="width: 100%; border-collapse: collapse; text-align: left;">
                <thead>
                    <tr style="background: var(--gray-50); border-bottom: 2px solid var(--gray-200);">
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">CANDIDATO</th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">SCORE IA</th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">ESTADO PROCESO</th>
                        <th style="padding: 1.25rem; color: var(--gray-700); font-weight: 600;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="tablaBody">
                    {% for c in candidatos %}
                    <tr class="candidato-row" 
                        data-estado="{{ c.estado if c.estado and c.estado != 'None' else 'Evaluado' }}" 
                        style="border-bottom: 1px solid var(--gray-100); transition: 0.2s;">
                        <td style="padding: 1.25rem;">
                            <div class="nombre-candidato" style="font-weight: 600; color: var(--gray-900); font-size: 1rem;">{{ c.nombre_candidato }}</div>
                            <div style="font-size: 0.8rem; color: var(--gray-500);">ID: {{ c.identificacion }}</div>
                        </td>
                        
                        <td style="padding: 1.25rem;">
                            <span class="score-mini {% if c.score|int >= 75 %}score-high{% elif c.score|int >= 50 %}score-medium{% else %}score-low{% endif %}" style="padding: 4px 10px; border-radius: 8px; font-weight: 700;">
                                {{ c.score if c.score is not none else 0 }}%
                            </span>
                        </td>

                        <td style="padding: 1.25rem;">
                            <select onchange="cambiarEstado('{{ c.id }}', this)" 
                                    class="crm-select 
                                    {% if c.estado == 'Agendado Meet' %}status-meet
                                    {% elif c.estado == 'Contratado' %}status-contratado
                                    {% elif c.estado == 'Rechazado' %}status-rechazado
                                    {% else %}status-evaluado{% endif %}">
                                <option value="Evaluado" {% if c.estado == 'Evaluado' or not c.estado or c.estado == 'None' %}selected{% endif %}>üÜï Evaluado por IA</option>
                                <option value="Agendado Meet" {% if c.estado == 'Agendado Meet' %}selected{% endif %}>üìÖ Agendado Meet</option>
                                <option value="Contratado" {% if c.estado == 'Contratado' %}selected{% endif %}>‚úÖ Contratado</option>
                                <option value="Rechazado" {% if c.estado == 'Rechazado' %}selected{% endif %}>‚ùå Rechazado</option>
                            </select>
                        </td>

                        <td style="padding: 1.25rem; display: flex; gap: 0.5rem;">
                            <button onclick="verDetalle('{{ c.nombre_candidato }}', '{{ c.fortalezas }}', '{{ c.debilidades }}', '{{ c.analisis_ia }}', '{{ c.score }}')" 
                                    class="btn-secondary" style="padding: 0.5rem 0.8rem; font-size: 0.8rem;">
                                üëÅÔ∏è Detalle
                            </button>

                            {% if c.telefono %}
                                <a href="https://wa.me/{{ c.telefono }}?text=Hola%20{{ c.nombre_candidato }},%20nos%20gustar√≠a%20agendar%20una%20entrevista%20por%20Meet..." target="_blank" 
                                   class="btn-primary" style="text-decoration: none; padding: 0.5rem 0.8rem; font-size: 0.8rem;">
                                    WhatsApp
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <div id="detalleModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal()">&times;</span>
            <h2 id="modalNombre" style="color: var(--gray-900);">Nombre</h2>
            <div id="modalScoreValue" style="display:inline-block; padding: 5px 15px; border-radius: 8px; font-weight: bold; margin-bottom: 1rem;">0%</div>
            <hr style="border: 0; border-top: 1px solid var(--gray-200); margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px;">
                    <h4>‚úÖ Fortalezas</h4>
                    <p id="modalFortalezas"></p>
                </div>
                <div style="background: #fef2f2; padding: 1.5rem; border-radius: 12px;">
                    <h4>‚ùå Debilidades</h4>
                    <p id="modalDebilidades"></p>
                </div>
            </div>
            <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 12px;">
                <h4>üí° An√°lisis Profundo (IA)</h4>
                <p id="modalAnalisis"></p>
            </div>
        </div>
    </div>

    <script>
        // FILTRADO POR PESTA√ëAS (CORREGIDO PARA VALORES NULOS)
        function filtrarPorPesta√±a(estadoRecibido, btn) {
    // 1. Gestionar botones de pesta√±as
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const rows = document.querySelectorAll('.candidato-row');
    let visibles = 0;

    rows.forEach(row => {
        // Obtenemos el estado y lo limpiamos de espacios
        let rowEstado = row.getAttribute('data-estado') || 'Evaluado';
        
        // Normalizamos: Si es nulo, vac√≠o o dice 'None', es 'Evaluado'
        if (rowEstado === 'None' || rowEstado === '' || rowEstado === 'null') {
            rowEstado = 'Evaluado';
        }

        let mostrar = false;

        if (estadoRecibido === 'TODOS') {
            mostrar = true;
        } else if (estadoRecibido === 'FINALIZADOS') {
            if (rowEstado === 'Contratado' || rowEstado === 'Rechazado') mostrar = true;
        } else if (estadoRecibido === 'Evaluado') {
            // L√≥gica especial para la Pesta√±a 1:
            // Muestra si el estado es 'Evaluado' O si el selector tiene seleccionado el primer √≠ndice
            const select = row.querySelector('.crm-select');
            if (rowEstado === 'Evaluado' || select.value === 'Evaluado') mostrar = true;
        } else {
            // Para 'Agendado Meet' y otros
            if (rowEstado === estadoRecibido) mostrar = true;
        }

        row.style.display = mostrar ? "" : "none";
        if (mostrar) visibles++;
    });

    document.getElementById('contadorCandidatos').innerText = visibles;
}
        function aplicarFiltros() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.candidato-row');
            let visibles = 0;

            rows.forEach(row => {
                const nombre = row.querySelector('.nombre-candidato').innerText.toLowerCase();
                // Solo buscamos entre los que ya est√°n visibles por la pesta√±a activa
                const isTabActive = row.getAttribute('style').indexOf('display: none') === -1;
                
                if (nombre.includes(searchText)) {
                    row.style.display = "";
                    visibles++;
                } else {
                    row.style.display = "none";
                }
            });
            document.getElementById('contadorCandidatos').innerText = visibles;
        }

        function cambiarEstado(id, elemento) {
            const nuevoEstado = elemento.value;
            const row = elemento.closest('.candidato-row');
            
            // 1. Actualizamos el atributo de la fila para que el filtro lo reconozca
            row.setAttribute('data-estado', nuevoEstado);

            // 2. Actualizamos los colores del selector (UI)
            elemento.classList.remove('status-evaluado', 'status-meet', 'status-contratado', 'status-rechazado');
            if (nuevoEstado === 'Agendado Meet') elemento.classList.add('status-meet');
            else if (nuevoEstado === 'Contratado') elemento.classList.add('status-contratado');
            else if (nuevoEstado === 'Rechazado') elemento.classList.add('status-rechazado');
            else elemento.classList.add('status-evaluado');

            // 3. Enviamos el cambio a la base de datos (Backend)
            fetch('/actualizar_estado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, estado: nuevoEstado })
            }).then(response => {
                if (!response.ok) {
                    alert("Error al guardar en base de datos.");
                } else {
                    // --- EL TRUCO EST√Å AQU√ç ---
                    // Buscamos cu√°l es la pesta√±a que est√° activa actualmente
                    const pesta√±aActiva = document.querySelector('.tab-btn.active');
                    
                    // Si no estamos en la pesta√±a "Todos", volvemos a filtrar 
                    // para que el candidato desaparezca de aqu√≠ y se mueva a su nueva pesta√±a
                    if (pesta√±aActiva && pesta√±aActiva.innerText !== 'Todos') {
                        // Ejecutamos la funci√≥n de filtrado con la pesta√±a actual
                        pesta√±aActiva.click(); 
                    }
                    console.log("‚úÖ Movido exitosamente");
                }
            });
        }

        function verDetalle(nombre, fortalezas, debilidades, analisis, score) {
            document.getElementById('modalNombre').innerText = nombre;
            document.getElementById('modalFortalezas').innerText = fortalezas || "N/A";
            document.getElementById('modalDebilidades').innerText = debilidades || "N/A";
            document.getElementById('modalAnalisis').innerText = analisis || "N/A";
            const scoreDiv = document.getElementById('modalScoreValue');
            scoreDiv.innerText = "Score IA: " + score + "%";
            
            const s = parseInt(score);
            scoreDiv.style.background = s >= 75 ? "#d1fae5" : (s >= 50 ? "#fef3c7" : "#fee2e2");
            scoreDiv.style.color = s >= 75 ? "#065f46" : (s >= 50 ? "#92400e" : "#991b1b");

            document.getElementById('detalleModal').style.display = "block";
        }

        function cerrarModal() { document.getElementById('detalleModal').style.display = "none"; }
        window.onclick = function(event) {
            if (event.target == document.getElementById('detalleModal')) cerrarModal();
        }
    </script>
</body>
</html>